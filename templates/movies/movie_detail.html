{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container details-container">
    {% if backdrops %}
        {% for backdrop in backdrops %}
            <img src="https://image.tmdb.org/t/p/original/{{ backdrop.file_path }}" alt="Backdrop" class="backdrop-image" style="opacity: 0;">
        {% endfor %}
    {% endif %}

    <div class="content-container">
        <div class="row">
            <div class="col-md-6">
                <img src="https://image.tmdb.org/t/p/w500/{{ movie.poster_path }}" alt="{{ movie.title }}">
            </div>
            <div class="col-md-6">
                <div>
                    <h1 class="display-1">{{ movie.title }}</h1>
                    <p><strong>Release Date:</strong> {{ movie.release_date }}</p>
                    <p><strong>Rating:</strong> {{ movie.vote_average }}/10</p>
                    <p><strong>Overview:</strong> {{ movie.overview }}</p>
                </div>
                <div>
                    <h3>Where to Watch</h3>
                    {% if watch_providers.flatrate or watch_providers.buy or watch_providers.rent %}
                        <div class="d-flex flex-wrap justify-content-start">
                            <div class="provider-logo">
                                <p>Buy:</p>
                                {% for provider in watch_providers.buy %}
                                    <a href="{{ provider.link }}" target="_blank" class="provider-logo">
                                        <img src="https://image.tmdb.org/t/p/w92/{{ provider.logo_path }}" alt="{{ provider.provider_name }}" class="img-fluid rounded">
                                    </a>
                                {% endfor %}
                            </div>
                            <div class="provider-logo">
                                <p>Rent:</p>
                                {% for provider in watch_providers.rent %}
                                    <a href="{{ provider.link }}" target="_blank" class="provider-logo">
                                        <img src="https://image.tmdb.org/t/p/w92/{{ provider.logo_path }}" alt="{{ provider.provider_name }}" class="img-fluid rounded">
                                    </a>
                                {% endfor %}
                            </div>
                        </div>
                    {% else %}
                        <p>No streaming providers available for this movie.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Horizontal Line -->
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-1 border-bottom"></div>

<!-- Reviews -->
<div class="container">
    <div class="row">
        <h2 class="display-4 text-center">Movie Reviews</h2>

        <!-- Cinemate Reviews -->
        <div class="col-md-6">
            <h3>Cinemate Reviews</h3>
            <div id="reviews">
                {% for review in reviews %}
                <div class="review p-3 mb-3 border rounded">
                    <div class="d-flex align-items-center mb-2">
                        <a href="{% url 'user_profile' review.user.username %}" class="fw-bold me-2">{{
                            review.user.username }}</a>
                        <span class="text-muted">{{ review.created_at|date:"F j, Y" }}</span>
                    </div>
                    {% if review.rating %}
                    <div class="d-flex align-items-center mb-2">
                        <span class="badge bg-warning text-dark">{{ review.rating }}/5</span>
                    </div>
                    {% endif %}
                    <p>{{ review.review_text }}</p>
                </div>
                <hr>
                {% empty %}
                <p>No reviews yet. Be the first to review!</p>
                {% endfor %}
            </div>

            {% if user.is_authenticated %}
            <h3>Leave a Review</h3>
            {% if movie.id %}
            <form method="POST" action="{% url 'reviews:submit_review' movie.id %}">
                {% csrf_token %}
                <div class="input-group mb-3">
                    <label class="input-group-text" for="rating">Your Rating</label>
                    <select class="form-select" id="rating" name="rating">
                        {% for value, label in review_form.fields.rating.choices %}
                        <option value="{{ value }}" {% if review_form.rating.value == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="input-group mb-4">
                    <span class="input-group-text">Your review</span>
                    <textarea name="review_text" id="review_text" class="form-control"
                        aria-label="Write your review here" placeholder="Write your review here">
                    {% if review_form.review_text.value %}{{ review_form.review_text.value }}{% endif %}
                    </textarea>
                </div>
                <button type="submit" class="btn btn-dark">Submit Review</button>
            </form>
            {% else %}
            <p>Error: Movie ID is missing. Review cannot be submitted.</p>
            {% endif %}
            {% else %}
            <p><a href="{% url 'login' %}">Login</a> to leave a review.</p>
            {% endif %}
        </div>


        <!-- TMDB Reviews -->
        <div class="col-md-6">
            {% if movie.reviews.results %}
            <h3>TMDB Reviews:</h3>
            {% for review in movie.reviews.results %}
            <div class="tmdb-review p-3 mb-3 border rounded">
                <p>
                    <strong>
                        <a href="https://www.themoviedb.org/u/{{ review.author }}" target="_blank">
                            {{ review.author }}
                        </a>
                    </strong>
                    - <small>{{ review.created_at|date:"F j, Y" }}</small>
                </p>

                {% if review.author_details.rating %}
                <p>‚≠ê {{ review.author_details.rating }}/10</p>
                {% endif %}

                <p>{{ review.content|truncatewords:20 }}</p>
            </div>
            {% endfor %}
            {% else %}
            <p>No TMDB reviews available.</p>
            {% endif %}
        </div>

    </div>
</div>
<!-- Horizontal Line -->
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-1 border-bottom"></div>

<!-- Cast -->
<h3>Cast:</h3>
<div class="row">
    {% for actor in cast %}
    <div class="col-sm text-center">
        <img src="https://image.tmdb.org/t/p/w185/{{ actor.profile_path }}" class="img-fluid rounded-circle"
            alt="{{ actor.name }}">
        <p class="mt-2"><strong>{{ actor.name }}</strong></p>
        <p class="text-muted">{{ actor.character }}</p>
    </div>
    {% endfor %}
</div>

<!-- Horizontal Line -->
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-1 border-bottom"></div>

<!--  Videos (Trailers) -->
<div id="trailerCarousel" class="carousel slide">
    <div class="carousel-inner">
        <h3>Trailers:</h3>
        {% for video in movie.videos.results %}
        <div class="carousel-item {% if forloop.first %}active{% endif %} text-center">
            <iframe width="70%" height="400" src="https://www.youtube.com/embed/{{ video.key }}" frameborder="0"
                allowfullscreen>
            </iframe>
        </div>

        {% endfor %}
    </div>
    <button class="carousel-control-prev" type="button" data-bs-target="#trailerCarousel" data-bs-slide="prev">
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Previous</span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#trailerCarousel" data-bs-slide="next">
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Next</span>
    </button>
</div>

<!-- Horizontal Line -->
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-1 border-bottom"></div>

<!-- Similar Movies -->
<h3>Similar Movies</h3>
<div class="horizontal-scroll-container">
    <div class="horizontal-scroll-content">
        {% for movie in movie.similar.results %}
        <div class="col-md-3">
            <div class="card mb-4 shadow-sm" style="height: 100%;">
                {% if movie.poster_path %}
                <img src="https://image.tmdb.org/t/p/w500/{{ movie.poster_path }}" class="card-img-top"
                    alt="{{ movie.title }}">
                {% else %}
                <img src="{% static 'images/movie-card-placeholder-img.png' %}" class="card-img-top"
                    alt="No Image Available">
                {% endif %}
                <div class="card-body d-flex flex-column justify-content-between">
                    <h6 class="card-title">{{ movie.title }}</h6><br>
                    <div class="btn-wrapper text-center d-flex justify-content-between">
                        <a href="/movies/{{ movie.id }}/" class="btn btn-dark btn-sm">Show More</a>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script src="{% static 'js/movie_details.js' %}"></script>

{% endblock %}